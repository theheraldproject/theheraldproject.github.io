<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" href="/herald/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/herald/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/herald/css/styles.css?1610982289774457475">
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.9.0">
<meta property="og:title" content="Bluetooth Distance Estimation">
<meta name="author" content="Herald Authors">
<meta property="og:locale" content="en_US">
<meta name="description" content="Distance Estimation research">
<meta property="og:description" content="Distance Estimation research">
<link rel="canonical" href="https://vmware.github.io/herald/bluetooth/distance">
<meta property="og:url" content="https://vmware.github.io/herald/bluetooth/distance">
<meta property="og:site_name" content="Herald Project">
<script type="application/ld+json">
{"description":"Distance Estimation research","url":"https://vmware.github.io/herald/bluetooth/distance","@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://vmware.github.io/herald/herald/img/herald.png"},"name":"Herald Authors"},"author":{"@type":"Person","name":"Herald Authors"},"headline":"Bluetooth Distance Estimation","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <title>Herald Project Docs - Bluetooth Distance Estimation</title>



<body id="docs">
  <div class="container-fluid site-outer-container">
    <div class="site-container">
      <header class="site-header">
    <div class="site-header-content">
        <div class="logo">
            <a href="/herald/" aria-label="Herald homepage"><img src="/herald/img/herald.png" class="logo" alt="Homepage"></a>
        </div>
        <ul class="nav-menu" id="header-nav">
            <li class="home"><a href="/herald/" title="Herald Project">Home</a></li>
            <li class="blog"><a href="/herald/blog" title="Blog Posts">Blog</a></li>
            <li class="community"><a href="/herald/community" title="Community">Community</a></li>
            <li class="docs"><a href="/herald/docs">Documentation</a></li>
            <li class="efficacy"><a href="/herald/efficacy" title="Efficacy Paper">Efficacy Paper</a></li>
        </ul>
        <div class="nav-mobile-link">
            <a href="javascript:void(0);" id="nav-mobile-toggle"></a>
        </div>
    </div>
</header>
      <div class="post-single-hero bg-color-med-blue">
        <div class="section">
            <div class="section-content">
              <h1>Bluetooth Distance Estimation</h1>
            </div>
        </div>
      </div>
        <div class="post-single-body">
        <div class="section section-card">
            <div class="section-content pt-4 pb-0">
              <div class="row">
                <div class="col-md-3">
                 <div class="row">
    <div class="dropdown mb-2">
        
            <span></span>
        
    </div>
</div>
                <nav class="navigation">
  <!-- If new pages are added to the site and the TOC needs to be updated, it
  can be overridden, using toc-mapping.yml -->
  

  
  <h5>Introduction</h5>
  <ul>
    
    <li>
      
        <a href="/herald/docs">Our documentation</a>
      
    </li>
    
  </ul>
  
  <h5>Applications</h5>
  <ul>
    
    <li>
      
        <a href="/herald/applications">Herald Applications</a>
      
    </li>
    
    <li>
      
        <a href="/herald/applications/ct">Contact Tracing</a>
      
    </li>
    
    <li>
      
        <a href="/herald/applications/p2p">Device to Device</a>
      
    </li>
    
    <li>
      
        <a href="/herald/applications/mesh">Bluetooth Mesh Gateways</a>
      
    </li>
    
  </ul>
  
  <h5>Herald Protocol</h5>
  <ul>
    
    <li>
      
        <a href="/herald/protocol/">About our protocol</a>
      
    </li>
    
    <li>
      
        <a href="/herald/protocol/custom">Non contact tracing uses</a>
      
    </li>
    
  </ul>
  
  <h5>Design Guide</h5>
  <ul>
    
    <li>
      
        <a href="/herald/design/">Herald's Design</a>
      
    </li>
    
    <li>
      
        <a href="/herald/design/core">Core philosophy</a>
      
    </li>
    
    <li>
      
        <a href="/herald/design/data">Data used</a>
      
    </li>
    
    <li>
      
        <a href="/herald/design/protocol">Protocol lifecycle</a>
      
    </li>
    
    <li>
      
        <a href="/herald/design/summary">Design summary</a>
      
    </li>
    
  </ul>
  
  <h5>Herald Payloads</h5>
  <ul>
    
    <li>
      
        <a href="/herald/payload">About Payloads</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/envelope">Herald Envelope Header</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/interop">Interoperability</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/common">Herald Common CT Inner Header</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/simple">Herald Simple Inner Payload</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/secured">Herald Secured Inner Payload (Draft)</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/beacon">Herald Beacon Payload (Draft)</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/inner">Herald-compatible Inner Payload</a>
      
    </li>
    
    <li>
      
        <a href="/herald/payload/outer">Custom outer &amp; inner payloads</a>
      
    </li>
    
  </ul>
  
  <h5>Development &amp; Integration Guide</h5>
  <ul>
    
    <li>
      
        <a href="/herald/guide/">How to integrate</a>
      
    </li>
    
    <li>
      
        <a href="/herald/guide/code">About the code</a>
      
    </li>
    
    <li>
      
        <a href="/herald/guide/api">API docs</a>
      
    </li>
    
    <li>
      
        <a href="/herald/guide/add">Import Herald</a>
      
    </li>
    
    <li>
      
        <a href="/herald/guide/ios">iOS app guide</a>
      
    </li>
    
    <li>
      
        <a href="/herald/guide/android">Android app guide</a>
      
    </li>
    
  </ul>
  
  <h5>About Contact Tracing</h5>
  <ul>
    
    <li>
      
        <a href="/herald/background">What is Contact Tracing?</a>
      
    </li>
    
    <li>
      
        <a href="/herald/background/glossary">Glossary of terms</a>
      
    </li>
    
    <li>
      
        <a href="/herald/background/approaches">Technology Approaches</a>
      
    </li>
    
  </ul>
  
  <h5>Bluetooth Research</h5>
  <ul>
    
    <li>
      
        <a href="/herald/bluetooth">Our Research</a>
      
    </li>
    
    <li>
      
        <a href="/herald/bluetooth/hardware">Hardware Issues</a>
      
    </li>
    
    <li>
      
        <a href="/herald/bluetooth/os">Operating System Issues</a>
      
    </li>
    
    <li>
      
        <a href="/herald/bluetooth/crowding">Crowding</a>
      
    </li>
    
    <li>
      
        <a href="/herald/bluetooth/distance">Distance Estimation</a>
      
    </li>
    
  </ul>
  
  <h5>Formal Specifications</h5>
  <ul>
    
    <li>
      
        <a href="/herald/specs">List and status</a>
      
    </li>
    
    <li>
      
        <a href="/herald/specs/protocol">Herald Protocol</a>
      
    </li>
    
    <li>
      
        <a href="/herald/specs/payload-beacon">Beacon Payload</a>
      
    </li>
    
    <li>
      
        <a href="/herald/specs/payload-extended">Extended Data Area</a>
      
    </li>
    
    <li>
      
        <a href="/herald/specs/payload-simple">Simple Payload</a>
      
    </li>
    
    <li>
      
        <a href="/herald/specs/payload-secured">Secured Payload</a>
      
    </li>
    
    <li>
      
        <a href="/herald/specs/payload-interop">International Interoperability</a>
      
    </li>
    
  </ul>
  
</nav>

                </div>
                <div class="col-md-8 offset-md-1">
                

  

                <h1 id="introduction">Introduction</h1>

<p>Measuring distance is a case of using a physical protocol based analogue, and later converting this based on physical attributes of the device and environment
to get to a distance estimation value.</p>

<h2 id="calibration-tool">Calibration tool</h2>

<p>Herald provides a sample <a href="https://github.com/vmware/herald-calibration">Bluetooth calibration tool</a>. Currently this supports iOS but Android is also in the works.</p>

<p>To use the tool on iOS simply:-</p>
<ul>
  <li>Clone the repository above</li>
  <li>Open the ios folder project in XCode</li>
  <li>Modify the signing authority to be your own</li>
  <li>Deploy locally on two iPhones and run the app</li>
</ul>

<p>Instructions of how to use the app are within it</p>

<p>To download the data after a test:-</p>
<ul>
  <li>Plug the phone in to your mac</li>
  <li>Navigate to the PHONE NAME device in Finder</li>
  <li>Go to the Files tab</li>
  <li>Find the Bluetooth Calibration folder</li>
  <li>Copy all files to your local machine</li>
</ul>

<p>After doing this you can generate analysis output:-</p>
<ul>
  <li>Open the r/calibration-analysis.R script in RStudio</li>
  <li>Follow the instructions in that file to point to your data and generate analysis output</li>
</ul>

<p>Please do contact us with any interesting Distance Estimation discoveries so we can
add them to this repository.</p>

<h2 id="practical-observations">Practical observations</h2>

<p>During the development of the protocol we noticed some trends and approaches that worked well in testing to make the RSSI value calculated more accurate. We ended up rejecting these in favour of a raw RSSI value recorded at a fixed point in time purely because a separate scientific research effort being led by The Alan Turing Institute and the University of Oxford was assessing how RSSI could be processed. These efforts did not result in the development team being asked to take multiple measurements or perform any other ‘at time of recording’ data processing operations.</p>

<p>Nevertheless we did discover two interesting aspects of RSSI recording and distribution we shall now detail for background information important to the design of a measure to assess accuracy.</p>

<h3 id="inability-to-use-one-distance-conversion-formula">Inability to use one distance conversion formula</h3>

<p>We have found in testing that some RSSI calculations by Bluetooth chipsets use different scaling for RSSI.</p>

<p>Some chipsets use a log(distance) approach as is shown in the below diagram for communication
between an iPhone 7 and iPhone 7+. (in both directions)</p>

<p>Others use an inverse distance-squared scale instead. In our testing this is true between an iPhone 6 and an iPhone X (in both directions)</p>

<p>If using the wrong scaling curve the distance estimation will be least accurate between 1.5 and 3.5 metres in our testing, causing quite a difference
to a risk estimation.</p>

<p>This has two implications:-</p>
<ul>
  <li>The appropriate distance conversion approach cannot be determine from calibration of a phone at a single distance - it must use several distances to determine the correct regression approach
    <ul>
      <li>This in turn dramatically increases the time taken to complete manual calibration in a radiation proof chamber. Alternative automated approaches should be considered.</li>
      <li>This also likely means many current Bluetooth calibration readings used for distance estimation are invalid</li>
    </ul>
  </li>
  <li>A log(distance) algorithm such as Prof Dr Ing’s <a href="/herald/efficacy/bibliography#a-2">[2]</a> approach to collecting calibration data cannot be solely relied upon, an equivalent process is needed for inverse square-distance too
    <ul>
      <li>This in turn increases the difficulty of passing on ever changing calibration data and new formulae to mobile apps for local distance estimation rather than centralised risk estimation (currently used decentralised approaches) and local summation as per the <a href="/herald/payload/secured">Herald secured payload</a>
</li>
    </ul>
  </li>
</ul>

<h3 id="running-mean-of-rssi-values-in-bluetooth">Running mean of RSSI values in Bluetooth</h3>

<p>During early development the iBeacon API was assessed. This was eventually rejected as it did not allow a mechanism for easily exchanging cryptographic material necessary to ensure privacy and security of a proximity detection protocol, or provide a continuous variable for distance estimation. Whilst attempting to replicate the style of functionality of the iBeacon API in Core Bluetooth on iOS we discovered that a more accurate RSSI value (and thus distance estimation) could be achieved by taking a simple running mean of the last 5 RSSI readings taken.</p>

<p>Whilst we did not have time to formally assess this improvement it appeared for short ranges to improve accuracy from 30cm to 10cm within a meter. It was also observed in an evaluation application showing both the iBeacon API and our RSSI mean model to respond quicker to changes in distance between devices, and settle down to an accurate value quicker than the iBeacon API itself. We presumed at the time that the iBeacon API must be doing something similar, but with perhaps more readings over a longer period of time.</p>

<p>Whilst crude, this is one way that abhorrent errors in individual RSSI readings could be alleviated in an algorithm to convert distance estimation analogues to distances. This calculation is out of scope of the paper.</p>

<h3 id="modal-value-of-a-set-of-regular-rssi-readings-in-bluetooth">Modal value of a set of regular RSSI readings in Bluetooth</h3>

<p>The author has produced a calibration application and calculated a basic algorithm for distance estimation as a reference model. The results discovered in this brief independent calibration work are of interest in to how bluetooth generally performs for distance estimation and so we publish the summary of them here in order to help inform debate. Other work has since been done by the Fraunhofer institute and the GSMA mobile phone manufacturers consortium to create a more accurate estimation algorithm and to provide calibration data.</p>

<p>I ran two calibration applications running on iOS to rapidly perform RSSI readings between the phones at a known measured distance. The application’s user interface allowed the tester to specify the distance, providing the ability to take tens of thousands of readings per distance in a single test cycle before uploading the data for analysis.</p>

<p>Below shows the output of that analysis. The R scripts used to produce this and the application itself is available on request under the Apache-2.0 license.</p>

<p>This application can be used to determine the ‘correct’ RSSI reading for two known phones at a particular distance, and thus useful for formal evaluation of a proximity detection protocol’s accuracy, and so we discuss the results here.</p>

<p><img src="/herald/images/distance-rssi-distribution.png" alt="RSSI distribution over thousands of readings at different distances"></p>

<p>The above images show over ten thousands readings per contact event over approximately 4-5 minutes at each distance. The iPhones were kept in the foreground allowing a very high rate of RSSI readings to be taken. This would not be the case in a real application but it was useful to be able to discover RSSI distribution over time at each distance.</p>

<p>The orange dashed line shows the modal RSSI value rather than the mean. The grey lines are standard deviations (based on means of course), but shown either side of the mode rather than mean.</p>

<p>The thick black lines show the cut off of 2 standard deviations from the mode. Some outlier RSSI values are recorded here, but our analysis excluded these from the final mode calculation in order to prevent skew in the data set. (rare occasional abhorrent values over 20 from the actual RSSI value do occur with Bluetooth).</p>

<p>The distributions are not quite normal. It is likely this is due to how radio waves propagate and where the receiver is exactly positioned based on the multiple of wavelengths distance the receiver is from the transmitter.</p>

<p>What is clear though is that the modal value provides a strong signal when compared to mean or median, and is unaffected, given enough readings, by any skew due to not being an exact multiple of wavelengths away from the transmitter.</p>

<p>We further analysed these modal values to determine if they could be used to discover an algorithm for distance estimation that would act as a stop gap prior to further research being done on distance estimation algorithms. Whilst not related to the measures in this paper it is useful to complete the description of our experiences with Bluetooth calibration data. This formula was used in one place in this paper - to convert the ‘distance’ in the mock data to a target RSSI value, and thus to help estimate any error due to distance analogue bounding in a given protocol and its effect on overall efficacy score.</p>

<p>The result of using these modal values was a logarithmic function that provided the following distribution. Note that the values for RSSI have been processed as a log before plotting. The function is not linear.</p>

<p><img src="/herald/images/distance-rssi-regression.png" alt="RSSI distance data regression"></p>

<p>This provided the following naive formula which we will call Fowler’s formula for want of a better name, named after the author, naturally.</p>

<p><img src="/herald/images/distance-rssi-formula.png" alt="Fowler's RSSI distance regression formula"></p>

<p>where D is the estimated distance in meters and RSSI-MODE is the modal RSSI value.</p>

<p>As per the chart the R value for the formula’s fit was close to -1. This is no surprise as we are basing our regression on the mode rather than mean. The very small p value, however, indicates a good fit to the recorded test values.</p>

<p>It should be noted that this function is only valid for these two iPhones used in the test. There was no standardisation or calibration for particular phone models done. The Fraunhofer Institute used a similar approach. Refer to Prof Dr Ing’s paper <a href="/herald/efficacy/bibliography#a-2">[2]</a> . It uses a similar log estimation function but based on the mean RSSI value observed whilst generating pairwise phone calibration values rather than the mode.</p>

<p>We recommend an analysis is done in future study to see how many RSSI values would need to be read in quick succession to provide a reliable modal RSSI value close to a point in time in order to see if its use provides a better estimation function. It is possible, however, that research on probabilistic estimation functions has surpassed the accuracy of both the Fraunhofer and Fowler algorithms.</p>

<h3 id="the-effect-of-movement-on-any-rssi-processing-approach">The effect of movement on any RSSI processing approach</h3>

<p>Any detection mechanism that uses multiple RSSI values within a time bucket will potentially provide a good fit if the phones are stationary for every RSSI reading in the set. If instead, however, the phones are on the move on different trajectories then this range of values may increase the error in the distance estimation.</p>

<p>We recommend further research to determine the effect on accuracy of different estimation functions in both static and moving conditions.</p>

                </div>
              </div>
            </div>
        </div>
        </div>
      <div class="section section-background-darkest-blue">
    <div class="section-content">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-lg-8">
                <h5>Getting Started</h5>
                <p>To help you get started, see the documentation.</p>
            </div>
            <div class="col-xs-12 col-sm-6 col-lg-3 offset-lg-1">
                <p><strong></strong></p>
                <a href="/herald/docs" class="btn btn-sm btn-primary btn-no-border">Documentation</a>
            </div>
        </div>
    </div>
</div>

<footer class="section site-footer">
    <div class="section-content">
        <div class="row justify-content-between align-items-center">
            <div class="col-12 col-md-5 mb-3 mb-md-0">
                <ul class="social-links text-center text-md-left">
                    
                    <li>
                      
                      <i class="fab fa-twitter fa-lg fa-fw mr-1"></i>
                      
                      <a href="https://twitter.com/HeraldBluetooth">Twitter</a>
</li>
                    
                    <li>
                      
                      <i class="fab fa-slack fa-lg fa-fw mr-1"></i>
                      
                      <a href="https://herald-bluetooth.slack.com/">Slack</a>
</li>
                    
                    <li>
                      
                      <i class="fa fa-rss fa-lg fa-fw mr-1"></i>
                      
                      <a href="feed.xml">RSS</a>
</li>
                    
                    <li>
                      
                      <i class="fab fa-github fa-lg fa-fw mr-1"></i>
                      
                      <a href="https://github.com/vmware/?q=herald">GitHub</a>
</li>
                    
                </ul>
            </div>
            <div class="col-12 col-md-7 text-center text-md-right">
              <a href="/herald/" aria-label="Herald homepage"><img src="/herald/img/herald.png" class="logo" alt="Homepage"></a>
            </div>
        </div>
        <div class="row align-items-center">
          <div class="col copyright text-center text-md-right mt-4">
            © 2021 Herald Authors.
            <a href="http://vmware.github.io/" class="vm-logo">A VMware-backed project. <img src="/herald/img/vm-logo.png" alt="VMware logo"></a>
          </div>
        </div>
    </div>
</footer>


<!-- JS -->
<script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" crossorigin="anonymous"></script>

<script src="/herald/js/jquery.matchHeight.js?1610982289774457475"></script>
<script src="/herald/js/scripts.js?1610982289774457475"></script>
    </div>
  </div>
</body>

</html>
